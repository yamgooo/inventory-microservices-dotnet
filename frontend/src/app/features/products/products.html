<hlm-sheet side="right" #sheet>
    <div class="flex flex-row gap-2 items-center">
        <ng-icon name="lucideClipboardList" size="1.5rem" />
        <h1 class="text-xl font-semibold">Gestión de Productos</h1>
    </div>
    <p class="text-gray-600 text-sm leading-relaxed">
        Gestiona el listado de productos registrado en la base de datos.
    </p>

    <div class="flex flex-row justify-between pt-4 pb-4">
        <div class="flex flex-row gap-2 items-center">
            <button hlmBtn variant="outline" size="sm" [hlmDropdownMenuTrigger]="filterMenu">
                <ng-icon hlm size="sm" name="lucideFilter" />
                Filtros
            </button>
            <input class="w-80" hlmInput type="text" placeholder="Buscar por nombre..." 
                   [(ngModel)]="nameSearchTerm" (keyup.enter)="onSearch()" />
        </div>

        <button hlmBtn hlmSheetTrigger variant="default" size="sm" (click)="createProduct()">
            Nuevo Producto
            <ng-icon hlm size="sm" name="lucidePlus" />
        </button>
    </div>

    <ng-template #filterMenu>
        <hlm-dropdown-menu class="w-72">
            <hlm-dropdown-menu-label>Filtros Avanzados</hlm-dropdown-menu-label>
            
            <div class="p-3 space-y-3">
                <div class="grid gap-2">
                    <label class="text-xs font-medium">Categoría</label>
                    <input hlmInput placeholder="Ej. Electrónica" [(ngModel)]="filters.category" />
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div class="grid gap-2">
                        <label class="text-xs font-medium">Stock Mín</label>
                        <input hlmInput type="number" placeholder="0" [(ngModel)]="filters.minStock" />
                    </div>
                    <div class="grid gap-2">
                        <label class="text-xs font-medium">Stock Máx</label>
                        <input hlmInput type="number" placeholder="999" [(ngModel)]="filters.maxStock" />
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div class="grid gap-2">
                        <label class="text-xs font-medium">Precio Mín</label>
                        <input hlmInput type="number" placeholder="0" [(ngModel)]="filters.minPrice" />
                    </div>
                    <div class="grid gap-2">
                        <label class="text-xs font-medium">Precio Máx</label>
                        <input hlmInput type="number" placeholder="9999" [(ngModel)]="filters.maxPrice" />
                    </div>
                </div>
            </div>

            <hlm-dropdown-menu-separator />

            <div class="p-2 flex gap-2">
                <button hlmBtn class="flex-1" size="sm" (click)="applyFilters()">Aplicar</button>
                <button hlmBtn variant="outline" class="flex-1" size="sm" (click)="clearAllFilters()">Limpiar</button>
            </div>
        </hlm-dropdown-menu>
    </ng-template>

    @if (isLoading()) {
        <div class="flex w-full justify-center items-center p-10">
            <div hlmItem variant="muted" class="flex items-center gap-4 p-4 border rounded-lg">
                <hlm-spinner />
                <div hlmItemTitle>Cargando datos...</div>
            </div>
        </div>
    }

    @if (!isLoading() && products().length > 0) {
        <div class="w-full">
            <div hlmTableContainer>
                <table hlmTable class="w-full">
                    <thead hlmTHead>
                        <tr hlmTr>
                            <th hlmTh class="w-16">Imagen</th>
                            <th hlmTh>Nombre</th>
                            <th hlmTh>Descripción</th>
                            <th hlmTh>Categoría</th>
                            <th hlmTh class="text-center">Stock</th>
                            <th hlmTh class="text-right">Precio</th>
                            <th hlmTh class="text-right">Activo</th>
                        </tr>
                    </thead>
                    <tbody hlmTBody>
                        @for (product of products(); track product.id) {
                            <tr hlmTr (click)="selectProduct(product.id, sheet)" 
                                class="cursor-pointer hover:bg-gray-50">
                                <td hlmTd>
                                    <img [src]="product.imageUrl || '/placeholder.png'" 
                                         class="w-12 h-12 object-cover rounded border" 
                                         alt="{{ product.name }}" />
                                </td>
                                <td hlmTd class="font-medium">{{ product.name }}</td>
                                <td hlmTd class="text-sm text-gray-600 max-w-xs truncate">
                                    {{ product.description }}
                                </td>
                                <td hlmTd>
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">
                                        {{ product.category }}
                                    </span>
                                </td>
                                <td hlmTd [class]="'text-center ' + (product.stock <= 0 ? 'text-red-700 font-bold' : '')">
                                    {{ product.stock }}
                                </td>
                                <td hlmTd class="text-right">$ {{ product.price }}</td>
                                <td hlmTd class="text-right font-semibold">$ {{ product.price * product.stock }}</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot hlmTFoot>
                        <tr hlmTr>
                            <td hlmTd [attr.colSpan]="6" class="font-medium">Total Activo</td>
                            <td hlmTd class="text-right font-bold text-lg">$ {{ totalActivo() }}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="flex justify-between items-center mt-4 px-2">
            <p class="text-sm text-gray-600">
                Mostrando {{ (currentPage() - 1) * pageSize + 1 }} - 
                {{ currentPage() * pageSize > totalCount() ? totalCount() : currentPage() * pageSize }} 
                de {{ totalCount() }} productos
            </p>

            <div class="flex gap-2">
                <button hlmBtn variant="outline" size="sm" (click)="previousPage()" 
                        [disabled]="currentPage() === 1">
                    Anterior
                </button>

                <span class="px-3 py-2 text-sm">
                    Página {{ currentPage() }} de {{ totalPages() }}
                </span>

                <button hlmBtn variant="outline" size="sm" (click)="nextPage()" 
                        [disabled]="currentPage() === totalPages()">
                    Siguiente
                </button>
            </div>
        </div>
    }

    @if (!isLoading() && products().length === 0) {
        <div class="flex w-full justify-center items-center p-10">
            <div hlmItem variant="muted" class="flex items-center gap-4 p-4 border rounded-lg">
                <ng-icon name="lucideClipboardList" size="1.5rem" class="text-gray-400" />
                <div hlmItemTitle>No se encontró ningún resultado.</div>
            </div>
        </div>
    }

    <app-product-form [productId]="selectedId()" (onSaved)="handleSaved(sheet)" 
                      (onDeleted)="handleDeleted(sheet)" />
</hlm-sheet>